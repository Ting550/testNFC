
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="Web NFC 範例" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Web NFC 敬老愛心號誌試辦</title>
    <script>
      window.addEventListener("error", function (error) {
        if (ChromeSamples && ChromeSamples.setStatus) {
          console.error(error);
          ChromeSamples.setStatus(error.message + " (瀏覽器可能不支援)");
          error.preventDefault();
        }
      });
    </script>
  </head>

  <body style="text-align: center;">
    <h2 style="margin: 0;">Web NFC 敬老愛心號誌試辦</h2>
    <p class="availability">
      <h4 style="margin: 0;">裝置需支援 NFC、Chrome 89+ 以上版本</h4>
    </p>

    <p style="width: 100vw; max-width: 300px; text-align: justify; margin: 0 auto">
      台中XXX及XXX路口主要幹道，路口行人通行綠燈延長控制      
      <br />
      <br />
      目前僅限於Android手機 Chrome瀏覽器。
      <br />
      <br />
    </p>

    <button id="scanButton" style="font-size: 1.5rem">掃描</button>
    <script>
      var ChromeSamples = {
        log: function () {
          var line = Array.prototype.slice
            .call(arguments)
            .map(function (argument) {
              return typeof argument === "string"
                ? argument
                : JSON.stringify(argument);
            })
            .join(" ");

          document.querySelector("#log").textContent += line + "\n";
        },

        clearLog: function () {
          document.querySelector("#log").textContent = "";
        },

        setStatus: function (status) {
          document.querySelector("#status").textContent = status;
        },

        setContent: function (newContent) {
          var content = document.querySelector("#content");
          while (content.hasChildNodes()) {
            content.removeChild(content.lastChild);
          }
          content.appendChild(newContent);
        },
      };
    </script>

    <h3>即時掃描結果</h3>
    <div id="output" style="width: 100vw; max-width: 300px; text-align: justify; margin: 0 auto">
      <div id="content"></div>
      <div id="status"></div>
      <pre id="log"></pre>
    </div>

    <script>
	
      if (/Chrome\/(\d+\.\d+.\d+.\d+)/.test(navigator.userAgent)) {
        // Let's log a warning if the sample is not supposed to execute on this
        // version of Chrome.
        if (89 > parseInt(RegExp.$1)) {
          ChromeSamples.setStatus("請使用 Chrome 89 + 以上版本");
        }
      }
    </script>

    <script>
      log = ChromeSamples.log;

      if (!("NDEFReader" in window)){
	  
        ChromeSamples.setStatus("裝置不支援 Web NFC");
		}
    </script>

    <script>
      scanButton.addEventListener("click", async () => {
        log("準備開始");

        try {
          const ndef = new NDEFReader();
          await ndef.scan();
          log("> 開始掃描");

          ndef.addEventListener("readingerror", () => {
            log("無法讀取，請更換 NFC Tag");
          });

		ndef.onreading = event => {
				const message = event.message;
				for (const record of message.records) {
				  if (record.recordType === 'text') {
					const textDecoder = new TextDecoder(record.encoding);
					console.log('Text record:', textDecoder.decode(record.data));
				  }
				  // Handle other record types (e.g., URL, MIME) as needed
				}
			  };
		ndef.addEventListener("reading", ({ message, serialNumber }) => {
			  log(`> Serial Number: ${serialNumber}`);
			  log(`> Records:(${message.records.length})`);
			});
			  
		//另一種寫網址
			const ndef = new NDEFReader();
			ndef.write({
			  records: [{ recordType: "url", data: "https://w3c.github.io/web-nfc/" }]
			}).then(() => {
			  console.log("Message written.");
			}).catch(error => {
			  console.log(`Write failed :-( try again: ${error}.`);
			});
		//NDEFMessage：records 属性
			  ndefReaderInst.onreading = (event) => {
				  const ndefMessage = event.message;
				  for (const record of ndefMessage.records) {
					console.log(`记录类型：  ${record.recordType}`);
					console.log(`MIME 类型： ${record.mediaType}`);
					console.log(`记录 id：   ${record.id}`);
					switch (record.recordType) {
					  case "text":
						// TODO：使用记录数据、语言和编码读取文本记录。
						break;
					  case "url":
						// TODO：读取带有记录数据的 URL 记录。
						break;
					  default:
					  // TODO：使用记录数据处理其他记录。
					}
				  }
				};


          ndef.addEventListener("reading", ({ message, serialNumber }) => {
            log(`> Serial Number: ${serialNumber}`);
            log(`> Records: (${message.records.length})`);
          });
        } catch (error) {
          log("錯誤:" + error);
        }
      });
    </script>
  </body>
</html>
